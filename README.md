# [2AOS](https://github.com/mscjourney/2AOS)

## Team members:

| Name | UNI |
|---|---|
| SeungHyun Sung | ss***4 |
| Anthony Marello | ap***9 |
| Anya Khatri | ak***9 |
| Osarobo Omokaro | oo***3 |


## GCP Production Links

`http://34.75.80.228:8080` - Server

`http://34.75.80.228:3001/login` - Client



## Local links

`http://localhost:8080` - Server

`http://localhost:3001` - Client



## Language and Platform



**Programming Language:**  Java  
**Platform:**  Linux  

# Travel Alert and Recommendation Service (TARS)

TARS is a Spring Boot REST API that lets clients:
- Register users with preference profiles (weather types, temperature ranges, favorite cities).
- Retrieve stored user profiles.
- Get weather recommendations (best upcoming days).
- Get real-time weather alerts for a location or for a user's saved cities.
- Fetch basic crime summary info for a state/offense.
- Create client accounts and provision tenant-scoped application users.

---

## Quick Start

### Prerequisites
- Java 17+
- Maven 3.9+
- Internet access (for external weather/crime data if implemented in models)

### Build & Run
```bash
mvn clean package
mvn spring-boot:run
```
Server defaults to: `http://localhost:8080`

---

## Configuration

Property | Purpose | Default
-------- | ------- | -------
`tars.data.path` | Filesystem path for legacy user preferences JSON (`User` objects) | `./data/userPreferences.json`
`tars.users.path` | Path for multi-tenant `TarsUser` entities | `./data/users.json`
`tars.client.data.path` | Path for client registry (`ClientService`) | `./data/clients.json`

Override in `src/main/resources/application.properties`:
```properties
tars.data.path=./data/userPreferences.json
tars.users.path=./data/users.json
tars.client.data.path=./data/clients.json
```

Test isolation:
```properties
# src/test/resources/application.properties
tars.data.path=target/test-userPreferences.json
tars.client.data.path=target/test-clients.json
```

Directories are created automatically if missing.

---

## Data Model Overview

### User Preference (`UserPreference`)
```json
{
  "id": 1,
  "weatherPreferences": ["Sunny", "Rain"],
  "temperaturePreferences": ["Mild", "Cold"],
  "cityPreferences": ["New York", "Boston"]
}
```
- `id` unique, non-negative.
- Lists may be empty; null lists normalized.

### Multi-tenant User (`TarsUser`)
```json
{
  "userId": 12,
  "clientId": 4,
  "username": "jdoe",
  "role": "ADMIN",
  "active": true,
  "signUpDate": "2025-11-02T14:21:11Z",
  "lastLogin": ""
}
```
- `username` uniqueness is enforced per `clientId` (case-insensitive).
- `userId` auto-generated by `TarsUserService` using an atomic counter (starts at max existing).
- Persistence uses atomic file replacement (temp file + move) to avoid corruption.

### Client
```json
{
  "clientId": 4,
  "name": "AcmeCorp",
  "apiKey": "GENERATED_SECURE_KEY",
  "rateLimitPerMinute": 60,
  "maxConcurrentRequests": 5
}
```
- `name` must be unique (case-insensitive) across all clients.
- `apiKey` is generated (cryptographically secure hex) and NOT returned in the create response (delivered out-of-band).
- Current implementation returns portal guidance instead of exposing the key directly.

### WeatherRecommendation
```json
{
  "city": "Raleigh",
  "recommendedDays": ["2025-10-24", "2025-10-26"],
  "message": "2 clear days found in the next 5-day window."
}
```

### WeatherAlert
```json
{
  "location": "Raleigh",
  "timestamp": "Thu Oct 23 10:15:00 EDT 2025",
  "alerts": [
    { "severity": "Moderate", "type": "Wind", "message": "Gusts up to 30mph" }
  ],
  "recommendations": ["Delay outdoor activities", "Secure loose items"],
  "currentConditions": {
    "temperatureF": 57.2,
    "humidity": 0.62,
    "status": "Windy"
  }
}
```

### CrimeSummary
```json
{
  "state": "NC",
  "month": "10",
  "year": "2025",
  "message": "Fetched crime data successfully for ASS : <raw API summary>"
}
```

---

## Multi-Tenant Client & User Management

### Client Lifecycle
- Create a client with unique name.
- API key is generated internally and withheld from response.
- Retrieval/rotation endpoints are planned (design placeholder); current model assumes secure out-of-band delivery (email/admin portal).

### TarsUser Lifecycle
- Created in context of a client (`clientId` required).
- Username uniqueness enforced (case-insensitive) per client.
- Activation status defaults to true; service supports future deactivation/update operations (e.g., `deactivateUser`, `updateLastLogin`).

### Persistence Characteristics
Component | File | Atomic Writes | Uniqueness/Validation
--------- | ---- | ------------- | ---------------------
Legacy Users (`User`) | `userPreferences.json` | Non-atomic (legacy) | Unique id on add
Tars Users (`TarsUser`) | `users.json` | Yes (temp then atomic move) | Username per client
Clients | `clients.json` | Currently non-atomic | Name uniqueness, key generation

Atomic write is recommended to be added to `ClientService` for consistency (future enhancement).

---

## Endpoints

Base path: `http://localhost:8080`

### Health / Index
GET `/` or `/index`  
Response: `"Welcome to the TARS Home Page!"`

### Client Management

#### Get All Clients
GET `/clients`

Description: Retrieves a list of all registered clients.

Response (200):
```json
[
  {
    "clientId": 1,
    "name": "AcmeCorp",
    "email": "contact@acme.com",
    "rateLimitPerMinute": 60,
    "maxConcurrentRequests": 5
  }
]
```

Errors:
- 500: Internal failure

#### Get Client by ID
GET `/clients/{clientId}`

Path Variable: `clientId` (long): ID of the client to retrieve.

Response (200): `Client` JSON object.

Errors:
- 400: Negative clientId
- 404: Client not found
- 500: Internal failure

#### Create Client
POST `/client/create`

Request:
```json
{ 
  "name": "AcmeCorp",
  "email": "contact@acme.com"
}
```
Response (201):
```json
{
  "clientId": 4,
  "name": "AcmeCorp",
  "email": "contact@acme.com",
  "rateLimitPerMinute": 60,
  "maxConcurrentRequests": 5
}
```
Errors:
- 400: Missing or blank `name` or `email`, or invalid email format
- 409: Duplicate client name or email
- 500: Internal failure (service returned null)

#### Create Client User
POST `/client/createUser`

Request:
```json
{
  "clientId": 4,
  "username": "jdoe",
  "email": "jdoe@example.com",
  "role": "ADMIN"
}
```

Response (201): `TarsUser` JSON object (see model above).

Errors:
- 400: Null body, invalid clientId, blank username/email/role, or invalid email format
- 404: Client not found
- 409: Username or email already exists for this client (case-insensitive)
- 500: Internal failure creating user

### TarsUser Management

#### Get All TarsUsers
GET `/tarsUsers`

Description: Retrieves a list of all TarsUsers across all clients.

Response (200): Array of `TarsUser` JSON objects.

Errors:
- 500: Internal failure

#### Get TarsUser by ID
GET `/tarsUsers/{userId}`

Path Variable: `userId` (long): ID of the user to retrieve.

Response (200): `TarsUser` JSON object.

Errors:
- 400: Negative userId
- 404: TarsUser not found
- 500: Internal failure

#### Delete TarsUser
DELETE `/tarsUsers/{userId}`

Path Variable: `userId` (long): ID of the user to delete.

Description: Deletes a TarsUser and their associated preferences.

Response (200): Deleted `TarsUser` JSON object.

Errors:
- 404: TarsUser not found
- 500: Internal failure

#### User Login
POST `/login`

Description: Authenticates a user by username, email, or userId and returns their data with preferences.

Request (one of the following):
```json
{ "username": "jdoe" }
```
or
```json
{ "email": "jdoe@example.com" }
```
or
```json
{ "userId": "12" }
```

Response (200):
```json
{
  "user": {
    "userId": 12,
    "clientId": 4,
    "username": "jdoe",
    "email": "jdoe@example.com",
    "role": "ADMIN",
    "active": true,
    "signUpDate": "2025-11-02T14:21:11Z",
    "lastLogin": "2025-12-04T10:30:00Z"
  },
  "preferences": {
    "id": 12,
    "weatherPreferences": ["Sunny"],
    "temperaturePreferences": ["Warm"],
    "cityPreferences": ["Austin"]
  }
}
```

Errors:
- 400: Missing username/email/userId, or invalid format
- 403: User account is inactive
- 404: User not found
- 500: Internal failure

### User Preferences

PUT `/setPreference/{id}`

Description: Adds/updates the preferences of the TarUser by id.

Path Variable: `id` (long): id of the TarUser to add/update preferences for.

Request: Expects a JSON payload (body) representing the UserPreferences
```json
{
    "id":1,
    "weatherPreferences":["sunny","clear"],
    "temperaturePreferences":["70F"],
    "cityPreferences":["Boston","New York"]
}
```
Response:
- `200 OK`: Returns the updated preferences.
- `400 Bad Request`: Error message if `id` was negative or `@PathVariable id` does not match JSON `id`.
- `404 Not Found`: TarsUser with the specified Id does not exist.

PUT `/clearPreference/{id}`

Description: Removes the preferences of the TarsUser by id.

Path Variable: `id` (long): id of the TarUser to remove preferences for.

Request: None

Response:
- `200 OK`: Returns a message saying the preferences have been cleared.
- `400 BAD_REQUEST`: Error message if `id` was negative or TarsUser with `id` did not have any existing preferences.
- `404 Not Found`: A TarsUser with the specified Id does not exist.

GET `/retrievePreference/{id}`

Description: Gets the preferences of the TarUser by id.

Path Variable: `id` (long): id of the TarUser to retrieve preferences for.

Request: None

Response:
- `200 OK`: Returns the TarsUser Preferences.
- `400 BAD_REQUEST`: Error message if `id` was negative or TarsUser with `id` did not have any existing preferences.
- `404 Not Found`: A TarsUser with the specified Id does not exist.

GET `/userPreferenceList`

Description: Retrieves a list of all existing preferences for all TarUsers.

Path Variable: None

Request: None

Response:
- `200 OK`: Returns a list of `UserPreference` objects.

#### Get User Preferences by Client
GET `/userPreferenceList/client/{clientId}`

Path Variable: `clientId` (long): ID of the client whose users' preferences to retrieve.

Description: Retrieves preferences for all users belonging to a specific client.

Response (200): Array of `UserPreference` JSON objects (includes users without preferences as empty preference objects).

Errors:
- 400: Negative or null clientId
- 500: Internal failure

### Weather Recommendation

GET `/recommendation/weather?city={city}&days={days}`

Query params:
- `city` (required)
- `days` (required, 1–14)

Responses:
- `200 OK` – `WeatherRecommendation`
- `400 BAD REQUEST` – invalid `days` range (≤0 or >14)
- `500 INTERNAL SERVER ERROR` – unexpected failure

Example:
```
GET /recommendation/weather?city=Raleigh&days=5
```

### Weather Recommendation (User Preference)

GET `/recommendation/weather/user/{userId}?city={city}&days={days}`

Path Variable:
- `userId` (required)

Query params:
- `city` (required)
- `days` (required, 1–14)

Responses:
- `200 OK` – `WeatherRecommendation`
- `400 BAD REQUEST` – invalid `days` range (≤0 or >14)
- `500 INTERNAL SERVER ERROR` – unexpected failure

Example:
```
GET /recommendation/weather/user/1?city=New York&days=10
```

### Weather Alerts

GET `/alert/weather?city={city}`  
OR  
GET `/alert/weather?lat={lat}&lon={lon}`

Rules:
- Either `city` OR both `lat` and `lon` must be provided.

Responses:
- `200 OK` – `WeatherAlert`
- `400 BAD REQUEST` – missing or invalid parameters
- `500 INTERNAL SERVER ERROR` – unexpected failure

### Weather Alerts (User Preferences)

GET `/alert/weather/user/{userId}`

Uses the user's `cityPreferences` to aggregate alerts.

Responses:
- `200 OK` – list of `WeatherAlert` objects
- `400 BAD REQUEST` – negative user ID
- `404 NOT FOUND` – no such user
- `500 INTERNAL SERVER ERROR` – unexpected failure

### Crime Summary

GET `/crime/summary?state={state}&offense={offense}&month={MM}&year={YYYY}`

Parameters:
- `state`: US state abbreviation (e.g., `NC`, `CA`)
- `offense`: allowed codes (e.g., `ASS`, `BUR`, `HOM`, `ROB`, `RPE`, `LAR`, `MVT`, `ARS`, `V`, `P`)
- `month`: two-digit month `01`–`12`
- `year`: four-digit year

Responses:
- `200 OK` – `CrimeSummary`
- `500 INTERNAL SERVER ERROR` – failure

Example:
```
GET /crime/summary?state=NC&offense=ASS&month=10&year=2025
```

### Country Alerts
GET `/country/{country}`

Generates a Travel Advisory Message for the provided country

Responses:
- `200 OK` - travel advisory message
- `404 NOT FOUND` - no such country
- `500 INTERNAL SERVER ERROR` = unexpected failure

GET `/countrySummary/{country}`

Generates a summary for the country including the travel advisory as well as country info.

Responses:
- `200 OK` - summary of alerts for the country
- `400 BAD REQUEST` - illegal argument (null / empty/whitespace string)
- `404 NOT FOUND` - no such country
- `500 INTERNAL SERVER ERROR` - failure

---

## Error Handling Summary

Error Type | Cause | HTTP Code
---------- | ----- | ---------
Duplicate client name | Existing case-insensitive match | 409
Duplicate client email | Existing email match | 409
Duplicate username (client scope) | Existing username under same clientId | 409
Duplicate email (client scope) | Existing email under same clientId | 409
Client not found | Invalid clientId | 404
TarsUser not found | Invalid userId | 404
User Preference not found | Invalid userId | 404
User inactive | User account is inactive | 403
Invalid clientId | Null or negative | 400
Invalid email format | Email doesn't match regex pattern | 400
Blank name / username / email / role | Empty trimmed string | 400
Invalid days | `days <= 0 || days > 14` | 400
Invalid city | API returns empty body | 404
Invalid country | Not found in json | 404
Missing alert params | Neither city nor lat/lon provided | 400
Missing crime params | Any of state, offense, month, year is missing | 400
Missing login params | No username, email, or userId provided | 400
Negative id | `< 0` | 400
Unexpected exception | Uncaught runtime errors | 500

---

## Example cURL Sessions

### Create Client
```bash
curl -X POST http://localhost:8080/client/create \
  -H "Content-Type: application/json" \
  -d '{"name":"OrbitAnalytics","email":"contact@orbit.com"}'
```

### Create Client User
```bash
curl -X POST http://localhost:8080/client/createUser \
  -H "Content-Type: application/json" \
  -d '{"clientId":4,"username":"jdoe","email":"jdoe@example.com","role":"ADMIN"}'
```

### Get All Clients
```bash
curl http://localhost:8080/clients
```

### Get Client by ID
```bash
curl http://localhost:8080/clients/4
```

### Get All TarsUsers
```bash
curl http://localhost:8080/tarsUsers
```

### Get TarsUser by ID
```bash
curl http://localhost:8080/tarsUsers/12
```

### Delete TarsUser
```bash
curl -X DELETE http://localhost:8080/tarsUsers/12
```

### User Login (by username)
```bash
curl -X POST http://localhost:8080/login \
  -H "Content-Type: application/json" \
  -d '{"username":"jdoe"}'
```

### User Login (by email)
```bash
curl -X POST http://localhost:8080/login \
  -H "Content-Type: application/json" \
  -d '{"email":"jdoe@example.com"}'
```

### Duplicate Client Name (Expect 409)
```bash
curl -X POST http://localhost:8080/client/create \
  -H "Content-Type: application/json" \
  -d '{"name":"OrbitAnalytics","email":"another@orbit.com"}'
```

### Duplicate Username (Case-insensitive, Expect 409)
```bash
curl -X POST http://localhost:8080/client/createUser \
  -H "Content-Type: application/json" \
  -d '{"clientId":4,"username":"JDOE","email":"anotherjdoe@example.com","role":"USER"}'
```


### Weather Recommendation
```bash
curl "http://localhost:8080/recommendation/weather?city=Austin&days=5"
```

---

## Logging Strategy

- All controller endpoints guarded with `logger.isInfoEnabled()/isWarnEnabled()/isDebugEnabled()/isErrorEnabled()`.
- Sensitive values (API keys) are never logged or included in `toString()` of `Client`.
- `TarsUserService` uses atomic persistence and logs creation, deactivation, last login updates.

---

## Security Posture (Current State)

Aspect | Current Behavior | Future Recommendation
------ | ---------------- | ---------------------
API Key Exposure | Not returned in client create response | Add secure retrieval endpoint + auth
Authentication | None (open API) | Integrate JWT or OAuth2
Role Handling | Free-form string | Constrain to enum (`ADMIN`, `USER`, etc.)
Rate Limiting | Static fields only | Enforce middleware (Bucket4j / Redis)
User Deactivation | Supported at service layer | Add controller endpoint
Client Key Rotation | Service-level function available (design placeholder) | Expose secure endpoint + audit log

---

## Persistence Behavior

Component | File | Notes
--------- | ---- | -----
Legacy Users | `userPreferences.json` | Synchronized writes; improvement: atomic temp replace
Tars Users | `users.json` | Atomic writes via temp file + `StandardCopyOption.ATOMIC_MOVE`
Clients | `clients.json` | Non-atomic currently; recommended enhancement
ID Generation | In-memory scan of max existing ID → increment | Rebuild counter on startup

---

## Testing

Run all tests:
```bash
mvn test
```
Surefire + Jacoco reports under `TeamProject/target/`.  
Coverage enforcement configured in GitHub Actions (see CI pipeline).

CI profile (aligns properties for CI runs):
```bash
cd TeamProject
mvn -Pci clean test jacoco:report
```
`src/main/resources/application-ci.properties` contains public path alignment and security header configuration for consistent CI behavior.

Equivalence Partitions:
- Contained in javadocs in Test Files which include Equivalence Partition for entrypoints and class methods.
- Equivalence Partitions for different entrypoints/methods are generally formatted as such:
    ```
    =========  <EntryPoint/Methods> ===========
    Equivalence Partition 1: <description>
        Test Cases: <testName>
    Equivalence Partition 2: <description>
        Test Cases: <testName>
    ...
    ```
- The individual partitions may be grouped together in the javadoc located at the beginning of the file 
or listed above specific test cases that test the equivalence partitions.
- Test Files that contain Equivalence Partition Listing
    - Controller (Entry Points)
        - `ClientEndpointsGetUnitTest.java`
        - `ClientEdnpointUnitTest.java`
        - `CountryEndpointTest.java`
        - `CrimeEndpointTest.java`
        - `RouteControllerUnitTest.java`
        - `TarsUserEndpointUnitTest.java`
        - `UserPreferenceEndpointTest.java`
        - `WeatherEndpointTest.java`
    - Models
        - `ClientTest.java`
        - `CountryModelTest.java` 
        - `CrimeModelTest.java` 
        - `TravelAdvisoryModelTest.java`
        - `WeatherAlertModelTest.java`
        - `WeatherModelTest.java`
    - Services
        - `ClientServiceTest.java` 
        - `TarsServiceTest.java` 
        - `TarsUserServiceTest.java` 

---

## Extensibility Ideas

- Add DTOs for request bodies (e.g., `CreateClientRequest`, `CreateTarsUserRequest`) to avoid raw `Map` binding.
- Introduce `ClientResponse` that masks or omits secret fields explicitly.
- Implement key retrieval + rotation endpoints with authentication & audit trail.
- Replace file-based persistence with a database (PostgreSQL + Flyway migrations).
- Add per-client rate limiting and usage metrics.
- Introduce standardized error payload shape (`{ "error": "...", "code": "..." }`).

---

## License

See `LICENSE` file in repository.

## Other Resources

- [JIRA Board](https://2aos.atlassian.net/jira/software/projects/SCRUM/boards/1)
- [PMD output result](TeamProject/pmd.txt)

### CI & Releases
- GitHub Actions runs lint, tests, and builds artifacts.
- Pushing a tag matching `v*.*.*` creates a GitHub Release attaching the built JAR and checksum.
  ```bash
  git tag v1.0.0
  git push origin v1.0.0
  ```

Run PMD manually (from `TeamProject`):
```bash
pmd check -d './' -R rulesets/java/quickstart.xml -r pmd.txt
```


---
